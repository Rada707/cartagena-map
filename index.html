<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Carte des arrondissements de Carthag√®ne (Colombie)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      position: relative;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    #map {
      width: 100%;
      height: 100vh;
    }

    .toolbar {
      position: absolute;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95);
      border-radius: 999px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      padding: 8px 18px;
      display: flex;
      gap: 16px;
      align-items: center;
      z-index: 1000;
      flex-wrap: wrap;
    }

    .tool-group {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .tool-btn {
      border: none;
      background: #f0f0f0;
      border-radius: 50%;
      width: 38px;
      height: 38px;
      font-size: 18px;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s;
    }

    .tool-btn.active {
      background: #0d6efd;
      color: #fff;
      box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.3);
    }

    .color-picker-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      font-weight: 600;
    }

    .color-picker-label input {
      width: 40px;
      height: 28px;
      border: none;
      padding: 0;
      background: none;
      cursor: pointer;
    }

    .user-pill {
      background: #f4f4f4;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 600;
    }

    .district-label {
      font-size: 11px;
      font-weight: bold;
      color: #202020;
      text-shadow:
        1px 1px 2px #ffffff,
        -1px -1px 2px #ffffff;
      border: none;
      background: transparent;
      box-shadow: none;
      pointer-events: none;
    }

    /* === Bo√Ætes de dialogue modales === */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      -webkit-backdrop-filter: blur(4px);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      animation: fadeIn 0.2s ease-out forwards;
    }

    @keyframes fadeIn {
      to {
        opacity: 1;
      }
    }

    @keyframes fadeOut {
      to {
        opacity: 0;
      }
    }

    @keyframes slideIn {
      from {
        transform: translateY(-20px) scale(0.95);
        opacity: 0;
      }
      to {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    }

    .modal-box {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      max-width: 500px;
      width: 90%;
      padding: 0;
      animation: slideIn 0.3s ease-out forwards;
      overflow: hidden;
    }

    .modal-header {
      padding: 24px 24px 16px 24px;
      border-bottom: 1px solid #e9ecef;
    }

    .modal-icon {
      font-size: 48px;
      margin-bottom: 12px;
      text-align: center;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: #212529;
      margin: 0 0 8px 0;
      text-align: center;
    }

    .modal-body {
      padding: 20px 24px;
      font-size: 15px;
      line-height: 1.6;
      color: #495057;
      white-space: pre-wrap;
      text-align: center;
    }

    .modal-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
      margin-top: 12px;
      transition: border-color 0.2s;
      box-sizing: border-box;
    }

    .modal-input:focus {
      outline: none;
      border-color: #0d6efd;
      box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
    }

    .modal-footer {
      padding: 16px 24px 24px 24px;
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .modal-btn {
      padding: 10px 24px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 100px;
    }

    .modal-btn-primary {
      background: #0d6efd;
      color: white;
    }

    .modal-btn-primary:hover {
      background: #0b5ed7;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
    }

    .modal-btn-secondary {
      background: #6c757d;
      color: white;
    }

    .modal-btn-secondary:hover {
      background: #5c636a;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
    }

    .modal-btn:active {
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <div class="tool-group">
      <button id="tool-select" class="tool-btn active" type="button" title="Mode normal (fl√®che)">‚Üñ</button>
      <button id="tool-pen" class="tool-btn" type="button" title="Colorier un barrio">‚úèÔ∏è</button>
      <button id="tool-erase" class="tool-btn" type="button" title="Effacer la couleur">üßΩ</button>
    </div>
    <label class="color-picker-label" title="Choisir la couleur du stylo">
      Couleur
      <input id="color-picker" type="color" value="#ff6200" />
    </label>
    <span class="user-pill" id="current-user">Utilisateur: ‚Ä¶</span>
  </div>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script src="supabase-config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // === Fonctions pour les bo√Ætes de dialogue modales personnalis√©es ===
    
    function customAlert(message, options = {}) {
      return new Promise(function(resolve) {
        const icon = options.icon || 'üí¨';
        const title = options.title || 'Information';
        
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        
        const modalBox = document.createElement('div');
        modalBox.className = 'modal-box';
        
        const header = document.createElement('div');
        header.className = 'modal-header';
        
        const iconDiv = document.createElement('div');
        iconDiv.className = 'modal-icon';
        iconDiv.textContent = icon;
        
        const titleDiv = document.createElement('div');
        titleDiv.className = 'modal-title';
        titleDiv.textContent = title;
        
        const body = document.createElement('div');
        body.className = 'modal-body';
        body.textContent = message;
        
        const footer = document.createElement('div');
        footer.className = 'modal-footer';
        
        const okBtn = document.createElement('button');
        okBtn.className = 'modal-btn modal-btn-primary';
        okBtn.textContent = 'OK';
        
        function closeModal() {
          overlay.style.animation = 'fadeOut 0.2s ease-out forwards';
          setTimeout(function() {
            if (overlay.parentNode) {
              overlay.parentNode.removeChild(overlay);
            }
            resolve();
          }, 200);
        }
        
        okBtn.addEventListener('click', closeModal);
        overlay.addEventListener('click', function(e) {
          if (e.target === overlay) {
            closeModal();
          }
        });
        
        footer.appendChild(okBtn);
        header.appendChild(iconDiv);
        header.appendChild(titleDiv);
        modalBox.appendChild(header);
        modalBox.appendChild(body);
        modalBox.appendChild(footer);
        overlay.appendChild(modalBox);
        document.body.appendChild(overlay);
        
        setTimeout(function() {
          okBtn.focus();
        }, 100);
      });
    }
    
    function customPrompt(message, defaultValue = '', options = {}) {
      return new Promise(function(resolve) {
        const icon = options.icon || '‚úèÔ∏è';
        const title = options.title || 'Saisie requise';
        
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        
        const modalBox = document.createElement('div');
        modalBox.className = 'modal-box';
        
        const header = document.createElement('div');
        header.className = 'modal-header';
        
        const iconDiv = document.createElement('div');
        iconDiv.className = 'modal-icon';
        iconDiv.textContent = icon;
        
        const titleDiv = document.createElement('div');
        titleDiv.className = 'modal-title';
        titleDiv.textContent = title;
        
        const body = document.createElement('div');
        body.className = 'modal-body';
        body.textContent = message;
        
        const input = document.createElement('input');
        input.className = 'modal-input';
        input.type = 'text';
        input.value = defaultValue;
        input.placeholder = defaultValue;
        
        body.appendChild(input);
        
        const footer = document.createElement('div');
        footer.className = 'modal-footer';
        
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'modal-btn modal-btn-secondary';
        cancelBtn.textContent = 'Annuler';
        
        const okBtn = document.createElement('button');
        okBtn.className = 'modal-btn modal-btn-primary';
        okBtn.textContent = 'OK';
        
        function closeModal(value) {
          overlay.style.animation = 'fadeOut 0.2s ease-out forwards';
          setTimeout(function() {
            if (overlay.parentNode) {
              overlay.parentNode.removeChild(overlay);
            }
            resolve(value);
          }, 200);
        }
        
        okBtn.addEventListener('click', function() {
          closeModal(input.value || defaultValue);
        });
        
        cancelBtn.addEventListener('click', function() {
          closeModal(null);
        });
        
        input.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            closeModal(input.value || defaultValue);
          }
        });
        
        overlay.addEventListener('click', function(e) {
          if (e.target === overlay) {
            closeModal(null);
          }
        });
        
        footer.appendChild(cancelBtn);
        footer.appendChild(okBtn);
        header.appendChild(iconDiv);
        header.appendChild(titleDiv);
        modalBox.appendChild(header);
        modalBox.appendChild(body);
        modalBox.appendChild(footer);
        overlay.appendChild(modalBox);
        document.body.appendChild(overlay);
        
        setTimeout(function() {
          input.select();
          input.focus();
        }, 100);
      });
    }
    
    // 1. Initialisation de la carte centr√©e sur Carthag√®ne
    const map = L.map('map').setView([10.3997, -75.5144], 12);

    // 2. Fond de carte OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // 3. Style des arrondissements
    const DEFAULT_FILL_COLOR = '#4da6ff';
    const DEFAULT_FILL_OPACITY = 0.25;

    function districtStyle() {
      return {
        color: '#003366',
        weight: 1.5,
        fillColor: DEFAULT_FILL_COLOR,
        fillOpacity: DEFAULT_FILL_OPACITY
      };
    }

    // === S√©lection des outils & couleur ===
    const toolSelectButton = document.getElementById('tool-select');
    const toolPenButton = document.getElementById('tool-pen');
    const toolEraseButton = document.getElementById('tool-erase');
    const colorPicker = document.getElementById('color-picker');
    const currentUserLabel = document.getElementById('current-user');

    let currentUser = 'Anonyme';
    customPrompt(
      'Entrez votre pr√©nom pour collaborer (visible par les autres):',
      'Anonyme',
      { icon: 'üë§', title: 'Bienvenue !' }
    ).then(function(value) {
      currentUser = value || 'Anonyme';
      currentUserLabel.textContent = 'Utilisateur: ' + currentUser;
    });

    // === Configuration Supabase (remplacer les placeholders) ===
    const supabaseSettings = window.__SUPABASE_CONFIG || {};
    const SUPABASE_URL = supabaseSettings.url;
    const SUPABASE_ANON_KEY = supabaseSettings.anonKey;
    const supabaseReady =
      typeof window.supabase !== 'undefined' &&
      typeof SUPABASE_URL === 'string' &&
      SUPABASE_URL.length > 0 &&
      typeof SUPABASE_ANON_KEY === 'string' &&
      SUPABASE_ANON_KEY.length > 0;
    const supabaseClient = supabaseReady
      ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      : null;

    if (!supabaseReady) {
      console.warn(
        'Supabase n‚Äôest pas configur√©. V√©rifiez supabase-config.js (g√©n√©r√© √† partir du fichier .env).'
      );
    }

    const barrioLayers = new Map();
    const colorState = new Map();

    let currentMode = 'select';
    let currentColor = colorPicker.value;

    function setMode(mode) {
      currentMode = mode;
      [toolSelectButton, toolPenButton, toolEraseButton].forEach(function(btn) {
        const btnMode = btn.dataset.mode || btn.id.replace('tool-', '');
        btn.classList.toggle('active', btnMode === mode);
      });
    }

    toolSelectButton.dataset.mode = 'select';
    toolPenButton.dataset.mode = 'pen';
    toolEraseButton.dataset.mode = 'erase';

    toolSelectButton.addEventListener('click', function() {
      setMode('select');
    });
    toolPenButton.addEventListener('click', function() {
      setMode('pen');
    });
    toolEraseButton.addEventListener('click', function() {
      setMode('erase');
    });
    colorPicker.addEventListener('input', function(e) {
      currentColor = e.target.value;
    });

    // 4. Pour chaque polygone: ajout du label permanent et enregistrement
    function onEachDistrict(feature, layer) {
      const props = feature.properties || {};
      const name =
        props.NOMBRE ||
        props.BARRIO ||
        props.NOMBRE_BARRIO ||
        props.NOM ||
        'Sans nom';

      layer.feature.properties.__displayName = name;

      layer.bindTooltip(name, {
        permanent: true,
        direction: 'center',
        className: 'district-label'
      });

      const code =
        props.CODIGO ||
        props.COD_BARRIO ||
        props.ID ||
        props.FID ||
        feature.id ||
        null;
      layer.feature.properties.__barrioCode = code;
      updatePopupContent(layer);

      if (code) {
        barrioLayers.set(code, layer);
        const existing = colorState.get(code);
        if (existing) {
          applyColorRecordToLayer(existing, layer);
        }
      }

      layer.on('click', function(e) {
        handleFeatureInteraction(e.target);
      });
    }

    async function handleFeatureInteraction(layer) {
      if (currentMode === 'pen') {
        await saveColorChange(layer, currentColor);
      } else if (currentMode === 'erase') {
        await eraseColor(layer);
      } else {
        layer.openPopup();
      }
    }

    function updatePopupContent(layer) {
      const name = layer.feature.properties.__displayName || 'Sans nom';
      const lastUser = layer.feature.properties.__lastUser;
      const color = layer.feature.properties.__customColor;
      let extraInfo = '';
      if (lastUser) {
        extraInfo = color
          ? '<br/><small>Colori√© par ' + lastUser + '</small>'
          : '<br/><small>Effac√© par ' + lastUser + '</small>';
      }
      layer.bindPopup('<strong>' + name + '</strong>' + extraInfo);
    }

    function applyColorRecordToLayer(record, layer, userOverride) {
      if (!layer) return;
      if (record && record.color) {
        layer.setStyle({
          fillColor: record.color,
          fillOpacity: 0.6
        });
        layer.feature.properties.__customColor = record.color;
      } else {
        layer.setStyle({
          fillColor: DEFAULT_FILL_COLOR,
          fillOpacity: DEFAULT_FILL_OPACITY
        });
        delete layer.feature.properties.__customColor;
      }
      layer.feature.properties.__lastUser =
        typeof userOverride !== 'undefined' ? userOverride : record ? record.user_name : null;
      updatePopupContent(layer);
    }

    async function saveColorChange(layer, color) {
      const code = layer.feature.properties.__barrioCode;
      if (!code) {
        console.warn('Impossible de sauvegarder: code barrio manquant');
        return;
      }
      const record = {
        barrio_code: code,
        color: color,
        user_name: currentUser
      };

      colorState.set(code, record);
      applyColorRecordToLayer(record, layer);

      if (!supabaseReady) {
        return;
      }

      const { error } = await supabaseClient
        .from('barrio_colors')
        .upsert(record, { onConflict: 'barrio_code' });
      if (error) {
        console.error('Erreur Supabase (upsert):', error);
        customAlert(
          'Impossible de sauvegarder la couleur: ' + error.message,
          { icon: '‚ö†Ô∏è', title: 'Erreur de sauvegarde' }
        );
      }
    }

    async function eraseColor(layer) {
      const code = layer.feature.properties.__barrioCode;
      if (!code) {
        console.warn('Impossible de supprimer: code barrio manquant');
        return;
      }

      colorState.delete(code);
      applyColorRecordToLayer(null, layer, currentUser);

      if (!supabaseReady) {
        return;
      }

      const { error } = await supabaseClient.from('barrio_colors').delete().eq('barrio_code', code);
      if (error) {
        console.error('Erreur Supabase (delete):', error);
        customAlert(
          'Impossible de supprimer la couleur: ' + error.message,
          { icon: '‚ö†Ô∏è', title: 'Erreur de suppression' }
        );
      }
    }

    async function loadExistingColors() {
      if (!supabaseReady) return;
      const { data, error } = await supabaseClient
        .from('barrio_colors')
        .select('barrio_code,color,user_name');
      if (error) {
        console.error('Erreur Supabase (select):', error);
        return;
      }
      data.forEach(function(record) {
        colorState.set(record.barrio_code, record);
        const layer = barrioLayers.get(record.barrio_code);
        if (layer) {
          applyColorRecordToLayer(record, layer);
        }
      });
    }

    function subscribeToRealtime() {
      if (!supabaseReady) return;
      supabaseClient
        .channel('public:barrio_colors')
        .on(
          'postgres_changes',
          { event: '*', schema: 'public', table: 'barrio_colors' },
          function(payload) {
            if (payload.eventType === 'DELETE') {
              const code = payload.old?.barrio_code;
              colorState.delete(code);
              const layer = barrioLayers.get(code);
              if (layer) {
                applyColorRecordToLayer(null, layer, payload.old?.user_name || null);
              }
            } else if (payload.new) {
              const record = payload.new;
              colorState.set(record.barrio_code, record);
              const layer = barrioLayers.get(record.barrio_code);
              if (layer) {
                applyColorRecordToLayer(record, layer);
              }
            }
          }
        )
        .subscribe(function(status) {
          if (status === 'SUBSCRIBED') {
            console.info('Connect√© au flux temps r√©el Supabase.');
          }
        });
    }

    if (window.location.protocol === 'file:') {
      customAlert(
        'Cette carte a besoin d\'un petit serveur local pour lire cartagena_barrios.geojson.\n' +
        'Depuis C:\\Development\\Cartagena lancez par exemple:\n' +
        '   python -m http.server 8000\n' +
        'Puis ouvrez http://localhost:8000/carte_cartagena.html',
        { icon: 'üåê', title: 'Serveur local requis' }
      );
    } else {
      fetch('cartagena_barrios.geojson')
        .then(function(response) {
          if (!response.ok) {
            throw new Error('Impossible de charger cartagena_barrios.geojson');
          }
          return response.json();
        })
        .then(function(data) {
          const geoLayer = L.geoJSON(data, {
            style: districtStyle,
            onEachFeature: onEachDistrict
          }).addTo(map);

          const bounds = geoLayer.getBounds();
          if (bounds.isValid()) {
            map.fitBounds(bounds);
          } else {
            console.warn('GeoJSON ne contient aucun polygone; centrage par d√©faut conserv√©.');
          }

          loadExistingColors().then(subscribeToRealtime);
        })
        .catch(function(error) {
          console.error(error);
          customAlert(
            'Erreur en chargeant le fichier GeoJSON des arrondissements.',
            { icon: '‚ùå', title: 'Erreur de chargement' }
          );
        });
    }
  </script>
</body>
</html>
